<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Vérificateur de Déploiement</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      color: #444;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .version {
      font-weight: bold;
      color: #4285f4;
      font-size: 1.2em;
    }
    .timestamp {
      color: #666;
      font-style: italic;
      margin-bottom: 15px;
    }
    .status {
      margin: 15px 0;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .pending {
      background-color: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }
    button {
      padding: 8px 15px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover {
      background: #3b78e7;
    }
    .table-info {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-family: monospace;
      max-height: 150px;
      overflow-y: auto;
    }
    #table-list {
      list-style-type: none;
      padding-left: 0;
    }
    #table-list li {
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Vérificateur de Déploiement</h2>
    
    <!-- Version du widget pour vérifier le déploiement -->
    <div class="version">Version: 1.0.3</div>
    <div class="timestamp">Déployé le: 21 Mai 2025 à 16:45</div>
    
    <!-- Statut de la connexion à Grist -->
    <div id="status" class="status pending">Vérification de la connexion à Grist...</div>
    
    <!-- Boutons de test -->
    <button id="test-connection">Tester la connexion</button>
    <button id="list-tables">Lister les tables</button>
    
    <!-- Informations sur les tables -->
    <div class="table-info" style="display: none;">
      <h3>Tables disponibles:</h3>
      <ul id="table-list"></ul>
    </div>
  </div>

  <script>
    // Éléments du DOM
    const statusEl = document.getElementById('status');
    const testBtn = document.getElementById('test-connection');
    const listTablesBtn = document.getElementById('list-tables');
    const tableInfo = document.querySelector('.table-info');
    const tableList = document.getElementById('table-list');
    
    // Fonction pour mettre à jour le statut
    function updateStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = 'status ' + type;
    }
    
    // Fonction pour initialiser la connexion à Grist
    async function initGrist() {
      try {
        // Vérifier si l'API Grist est disponible
        if (typeof grist === 'undefined') {
          updateStatus("API Grist non disponible. Vérifiez que le widget est déployé dans Grist.", "error");
          return false;
        }
        
        // Initialiser l'API
        await grist.ready({requiredAccess: 'read'});
        updateStatus("Connexion à Grist établie avec succès!", "success");
        console.log("[Vérificateur] Connexion établie à", new Date().toLocaleTimeString());
        return true;
      } catch (err) {
        updateStatus("Erreur de connexion à Grist: " + err.message, "error");
        console.error("[Vérificateur] Erreur:", err);
        return false;
      }
    }
    
    // Fonction pour tester la connexion
    async function testConnection() {
      updateStatus("Test de connexion en cours...", "pending");
      const success = await initGrist();
      
      if (success) {
        // Afficher des informations sur la session
        console.log("[Vérificateur] Widget déployé et connecté à Grist");
      }
    }
    
    // Fonction pour lister les tables
    async function listTables() {
      try {
        // S'assurer que la connexion est établie
        if (typeof grist === 'undefined') {
          updateStatus("API Grist non disponible", "error");
          return;
        }
        
        updateStatus("Récupération des tables...", "pending");
        
        // Récupérer les tables
        const tables = await grist.docApi.listTables();
        
        // Afficher les tables
        tableList.innerHTML = '';
        if (tables && tables.length > 0) {
          tables.forEach(table => {
            const li = document.createElement('li');
            li.textContent = table;
            tableList.appendChild(li);
          });
          
          updateStatus(`${tables.length} tables trouvées!`, "success");
          tableInfo.style.display = 'block';
          
          // Vérifier si demande_d_achat existe
          const hasTargetTable = tables.includes('demande_d_achat');
          console.log("[Vérificateur] Table demande_d_achat existe:", hasTargetTable);
          
          // Chercher des variantes possibles
          const variants = tables.filter(t => 
            t.toLowerCase().includes('demande') && 
            t.toLowerCase().includes('achat')
          );
          
          if (variants.length > 0) {
            console.log("[Vérificateur] Variantes trouvées:", variants);
          }
        } else {
          updateStatus("Aucune table trouvée dans le document", "error");
        }
      } catch (err) {
        updateStatus("Erreur lors de la récupération des tables: " + err.message, "error");
        console.error("[Vérificateur] Erreur:", err);
      }
    }
    
    // Ajouter les écouteurs d'événements
    testBtn.addEventListener('click', testConnection);
    listTablesBtn.addEventListener('click', listTables);
    
    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      console.log("[Vérificateur] Widget chargé à", new Date().toLocaleTimeString());
      setTimeout(initGrist, 500);
    });
  </script>
</body>
</html>
