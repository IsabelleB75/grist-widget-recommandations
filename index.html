let currentRowId = null;
let currentColumn = "commentaires";
let currentTable = null; // Ajouté

grist.ready({
  requiredAccess: 'full',
  columns: [{name: "commentaires", title: "Commentaire", type: "Text"}]
});

const textarea = document.getElementById("editor");
const status = document.getElementById("status");

grist.onRecord((record, mappings) => {
  if (record && record.id) {
    currentRowId = record.id;
    // Récupérer le nom réel de la table utilisée :
    currentTable = (mappings && mappings.tableId) ? mappings.tableId : grist.tableId || "demande_d_achat";
    textarea.value = record.fields[currentColumn] || "";
    status.textContent = "Commentaire chargé.";
    status.classList.remove("error");
  } else {
    currentRowId = null;
    textarea.value = "";
    status.textContent = "Aucune ligne sélectionnée.";
    status.classList.remove("error");
  }
});

textarea.addEventListener("input", async () => {
  if (!currentRowId || !currentTable) return;
  const newValue = textarea.value;

  try {
    await grist.docApi.applyUserActions([
      ["UpdateRecord", currentTable, currentRowId, { [currentColumn]: newValue }]
    ]);
    status.textContent = "✅ Enregistré !";
    status.classList.remove("error");
  } catch (err) {
    console.error("Erreur d'enregistrement :", err);
    status.textContent = "❌ Erreur d'enregistrement : " + (err?.message || err);
    status.classList.add("error");
  }
});
